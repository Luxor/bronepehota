# Feature Specification: Реализация официальных правил расчёта боя

**Feature Branch**: `003-official-rules`
**Created**: 2025-01-11
**Status**: Draft
**Input**: User description: "rules-originnal.pdf - фанатские прравила и официалные Bronepekhota_Pravila_05_08_08.pdf, сильно различаются при расчете атаки пехоты (по дальности и мошьности), также существенно отличается механизм повреждений и расчёт атаки для техники и орудий. Изучи правила в pdf файлах и используй расчёты согласно радакции правил для техники и пехоты (измени расчёты в rules/*.ts). Приложи информационный текст обьясняющий правила расчётов, чтобы он был видим для пользователя"

## Clarifications

### Session 2025-01-11

- **Q**: Какой метод расчёта урона по технике используется в фанатских правилах Панова?
- **A**: В фанатских правилах (стр. 27 rules-originnal.pdf) используется механика сравнения кубика мощности с зоной шкалы прочности (зелёная/жёлтая/красная). При пробитии урон зависит от типа кубика: D6 = 1 урон, D12 = 2 урона, D20 = 3 урона. Примечание: предыдущее утверждение о D20 таблице с модификаторами было некорректным.
- **Q**: Параметры мощность и дальность в армлистах могут иметь формат с бонусом (например, 2D6+2). Как бонус должен применяться в расчётах?
- **A**: Бонус в формате `XdY+Z` (например, `2D6+2`) должен прибавляться к сумме всех бросков кубиков для попадания. Для урона в официальных правилах ("Виртуальная стрельба", стр. 14): бонус НЕ применяется, каждый кубик мощности напрямую сравнивается с бронёй цели. В фанатских правилах: бонус добавляется к каждому кубику перед сравнением с бронёй.
- **Q**: Как работает урон по пехоте в официальных правилах - есть ли таблица средних значений?
- **A**: НЕТ таблицы средних значений. В официальных правилах (стр. 14, глава "Виртуальная стрельба") урон рассчитывается в реальном времени: каждый кубик мощности, который ПРЕВЫШАЕТ броню цели, наносит 1 ранение. Например: мощь 2D6 против брони 2 - бросаем 2 кубика, каждый результат >2 даёт 1 урон (средний ≈1.33).
- **Q**: Как работает урон техники по технике в официальных правилах - суммируются ли кубики?
- **A**: Кубики НЕ суммируются. При атаке техники по технике каждый кубик сравнивается с бронёй отдельно. Если кубик > брони, наносится 1 урон. Это та же механика "Виртуальной стрельбы" (стр. 14), применяется ко всем атакам.
- **Q**: Как работает урон пехоты по пехоте в фанатских правилах и влияют ли укрепления?
- **A**: В фанатских правилах каждый кубик мощности бросается с бонусом (если есть), затем каждый результат > брони наносит 1 ранение. Укрепления (укрытия) цели влияют на эффективную дистанцию атаки: лёгкое укрытие = +1 к дистанции, полное укрытие/бункер = +2 к дистанции.
- **Q**: Как укрепления влияют на расчёт в официальных правилах?
- **A**: В официальных правилах укрепления влияют на броню цели (не на дистанцию). Лёгкое укрепление (окопы) = +1 к эффективной брони, бункер = +2 к эффективной брони. Это применяется при расчёте урона по механике "Виртуальной стрельбы".
- **Q**: Как работает рукопашный бой по фанатским правилам?
- **A**: В фанатских правилах рукопашный бой использует ту же механику, что и официальные: D6+ББ атакующего vs D6+ББ защитника, победитель определяется по большей сумме, урон = разница totals. Механика идентична для обеих редакций правил.
- **Q**: Как работает урон техники по технике в фанатских правилах?
- **A**: В фанатских правилах (стр. 9) урон техники по технике НЕ зависит от брон цели. Вместо этого каждый кубик мощности напрямую вычитается из прочности: D6 = 1 урон, D12 = 2 урона, D20 = 3 урона. Нет разницы между атакой пехоты и техники - обе используют одну и ту же механику прямого вычитания урона из прочности по значению кубика.

### Session 2025-01-14

- **Q**: Применяется ли бонус в мощности (например, `2D6+2`) к урону в официальных правилах?
- **A**: ДА, бонус в мощности ДОЛЖЕН прибавляться к каждому кубику перед сравнением с броней в официальных правилах (как в фанатских). Предыдущее утверждение что бонус не применяется было некорректным.
- **Q**: Как секторы скорости техники влияют на расчёт попадания в официальных правилах?
- **A**: Секторы скорости НЕ влияют на расчёт попадания - они только влияют на движение техники (максимальную дистанцию перемещения). Предыдущее утверждение что сниженная скорость увеличивает дистанцию атаки было некорректным.
- **Q**: Как обрабатываются критические попадания при уроне по технике в официальных правилах?
- **A**: Критические попадания НЕ реализуются в текущей версии - урон просто вычитается из прочности техники без дополнительных эффектов.
- **Q**: Как работает урон техники по технике в фанатских правилах - применяется ли механика "Виртуальной стрельбы"?
- **A**: НЕТ, урон техники по технике в фанатских правилах НЕ использует "Виртуальную стрельбу". Урон рассчитывается путём сравнения значения кубика мощности с зоной шкалы прочности (зелёная/жёлтая/красная). Если кубик мощности > максимального значения текущей зоны прочности, броня пробита и техника получает урон. Предыдущее утверждение что броня НЕ учитывалось было некорректным.
- **Q**: Насколько подробным должен быть информационный текст о правилах в интерфейсе?
- **A**: Краткое описание механики расчёта (таблица попадания/виртуальная стрельба), которое появляется при нажатии на иконку информации. Не должно загромождать основной интерфейс.
- **Q**: Как работает расчёт попадания в официальных правилах - используется ли таблица требуемых бросков или прямое сравнение?
- **A**: В официальных правилах (Раздел 7) используется ПРЯМОЕ СРАВНЕНИЕ: бросается кубик дальности, результат сравнивается с расстоянием до цели. Если результат броска >= расстоянию, попадание точное. Таблицы на стр. 13 НЕ используются для расчёта попадания. Предыдущее утверждение о lookup-таблице требуемых бросков было некорректным.

### Session 2025-01-14 (Анализ PDF)

- **Q**: Как работает урон по технике в фанатских правилах - различаются ли механики для атаки пехоты по технике и техники по технике?
- **A**: НЕТ, механика НЕ различается. Согласно фанатским правилам (стр. 27), "Повреждения, наносимые боевым машинам, высчитываются следующим образом. Сравниваются выпавшее значение кубика соответствующего мощности орудия, из которого стреляли по боевой машине (Д6, Д12 или Д20) и максимального значения зоны шкалы прочности". Оба типа атаки используют ОДНУ И ТУ ЖЕ механику сравнения с зоной прочности. D20 таблица с модификаторами НЕ используется.
- **Q**: Какое количество урона наносится по технике в фанатских правилах при пробитии брони?
- **A**: Согласно фанатским правилам (стр. 27): "Орудия с мощностью Д6 отнимают 1 единицу прочности техники, Д12 – 2 единицы прочности, а Д20 – 3 единицы прочности". Урон зависит от типа кубика мощности, а не от количества кубиков.
- **Q**: Соответствует ли текущая реализация в rules/fan.ts фанатским правилам для урона по технике?
- **A**: НЕТ. Текущая реализация использует механику "каждый кубик > брони = 1 урон", что соответствует официальным правилам (Виртуальная стрельба), но НЕ соответствует фанатским правилам. В фанатских правилах должна использоваться механика сравнения с зоной прочности с фиксированным уроном по типу кубика.

## Out of Scope

Следующие функции ЯВНО НЕ входят в текущую спецификацию и вынесены в будущие версии:
- **Критические попадания**: Механика критических попаданий и дополнительных эффектов при уроне по технике (например, уничтожение экипажа при попадании 20+)
- **Уровни повреждения техники в официальных правилах**: Пошаговое снижение характеристик (скорость, атака) при получении урона - только фанатские правила имеют таблицу с 5 уровнями повреждений
- **Специальные эффекты оружия**: Взрыв, Ремонт, Burst и другие спецэффекты из фанатских правил (уже реализованы в `rules/fan.ts`)
- **Мораль и проверка на панику**: Механика моральных проверок при потерях
- **Альтернативные режимы стрельбы**: Очередной огонь, прицельная стрельба и другие модификаторы

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Расчёт попадания пехоты по официальным правилам (Priority: P1)

При стрельбе из стрелкового оружия пехота использует механику прямого сравнения из официальных правил (Раздел 7): бросается кубик дальности оружия, результат сравнивается с расстоянием до цели. Если результат броска >= расстоянию, попадание точное.

**Why this priority**: Это фундаментальная механика боя. Без правильного расчёта попадания вся боевая система работает неверно. Текущая реализация использует формулу `total >= distanceSteps`, которая СООТВЕТСТВУЕТ официальным правилам (Раздел 7).

**Independent Test**: Атака пехотинца на разных дистанциях с разной дальностью оружия и проверка результата по правилу из Раздела 7: бросок кубика дальности >= расстоянию = попадание.

**Acceptance Scenarios**:

1. **Given** солдат с дальностью "D6" стреляет на дистанцию 1, **When** выполняется бросок D6 и выпадает 3, **Then** попадание точное (3 >= 1)
2. **Given** солдат с дальностью "D6" стреляет на дистанцию 2, **When** выполняется бросок D6 и выпадает 2, **Then** попадание точное (2 >= 2)
3. **Given** солдат с дальностью "D6" стреляет на дистанцию 4, **When** выполняется бросок D6 и выпадает 3, **Then** промах (3 < 4)
4. **Given** солдат с дальностью "D12" стреляет на дистанцию 5, **When** выполняется бросок D12 и выпадает 5, **Then** попадание точное (5 >= 5)
5. **Given** солдат с дальностью "D20" (гранатомёт) стреляет на дистанцию 8, **When** выполняется бросок D20 и выпадает 7, **Then** промах (7 < 8)
6. **Given** солдат с дальностью "ББ" (рукопашная) атакует на дистанции 1, **When** выполняется расчёт попадания, **Then** попадание автоматическое (без броска, дистанция 0 для рукопашной)
7. **Given** солдат с дальностью "D6+2" стреляет на дистанцию 3, **When** выполняется бросок D6 и выпадает 1, **Then** попадание точное (1+2=3 >= 3)
8. **Given** гранатомёт с дальностью "D20+2" стреляет на дистанцию 8, **When** выполняется бросок D20 и выпадает 6, **Then** попадание точное (6+2=8 >= 8)

---

### User Story 2 - Расчёт урона пехоты по официальным правилам (Priority: P1)

При попадании пехота использует механику "Виртуальной стрельбы" из официальных правил (страница 14 в Bronepekhota_Pravila_05_08_08.pdf): каждый кубик мощности, который ПРЕВЫШАЕТ броню цели, наносит 1 ранение. Нет таблицы средних значений - урон определяется бросками кубиков в реальном времени.

**Why this priority**: Без правильного расчёта урона результаты боя не соответствуют официальным правилам. Текущая реализация в `rules/tehnolog.ts` НЕ использует механику "Виртуальной стрельбы" из стр. 14.

**Independent Test**: Попадание с разной мощью и бронёй цели, проверка количества ранений по правилу "каждый кубик > брони = 1 ранение" из PDF (стр. 14). Например: Мощь 2D6 против брони 2 - в среднем 1.33 ранения (не 2.5 как в текущей реализации).

**Acceptance Scenarios**:

1. **Given** попадание с мощью "1D6" по цели с бронёй 0, **When** выполняется расчёт урона, **Then** каждый результат кубика >0 наносит 1 ранение (средний урон ≈3.5)
2. **Given** попадание с мощью "1D6" по цели с бронёй 1, **When** выполняется расчёт урона, **Then** каждый результат кубика >1 наносит 1 ранение (средний урон ≈1.67)
3. **Given** попадание с мощью "1D6" по цели с бронёй 2, **When** выполняется расчёт урона, **Then** каждый результат кубика >2 наносит 1 ранение (средний урон ≈0.67)
4. **Given** попадание с мощью "2D6" по цели с бронёй 1, **When** выполняется расчёт урона, **Then** каждый кубик >1 наносит 1 ранение (средний урон ≈2.67)
5. **Given** попадание с мощью "2D6" по цели с бронёй 3, **When** выполняется расчёт урона, **Then** каждый кубик >3 наносит 1 ранение (средний урон ≈0.33)
6. **Given** попадание с мощью "2D6+2" по цели с бронёй 2, **When** выполняется расчёт урона в официальных правилах, **Then** каждый кубик бросается с +2 бонусом (каждый результат = roll+2), затем каждый результат+2 > 2 наносит 1 ранение
7. **Given** попадание с мощью "2D+2" по цели с бронёй 5 в тяжёлых укреплениях (бункер+) в официальных правилах, **When** выполняется расчёт урона, **Then** эффективная броня = 5+3=8, кубик результата+2 > 8 наносит 1 ранение
8. **Given** попадание с мощью "2D6+2" по цели с бронёй 2, **When** выполняется расчёт урона в фанатских правилах, **Then** каждый кубик бросается с +2 бонусом (каждый результат = roll+2), затем каждый сравнивается с бронёй 2 (roll+2 > 2 = урон) - механика идентична официальным правилам
9. **Given** цель в тяжёлых укреплениях (бункер+) в официальных правилах, **When** выполняется расчёт урона, **Then** эффективная броня увеличивается на +3 по сравнению с базовой бронёй
10. **Given** цель в лёгких укреплениях (окопы) в официальных правилах, **When** выполняется расчёт урона, **Then** эффективная броня увеличивается на +1 по сравнению с базовой бронёю

---

### User Story 3 - Расчёт попадания и урона техники по официальным правилам (Priority: P2)

При атаке техники (машин) используется специальная механика из официальных правил (страницы 15-16): урон вычитается из прочности. Критические попадания и особые эффекты повреждения НЕ реализуются в текущей версии. Секторы скорости влияют только на движение техники, не на расчёт попадания.

**Why this priority**: Техника составляет значительную часть армии, и её боевая механика существенно отличается от пехоты в официальных правилах. Критические попадания вынесены в будущую версию.

**Independent Test**: Атака техники на разных дистанциях и с разной текущей прочностью, проверка результата по таблицам из PDF (стр. 15-16).

**Acceptance Scenarios**:

1. **Given** техника с оружием "D12" стреляет на дистанцию 4, **When** выполняется расчёт попадания, **Then** используется таблица для техники (стр. 15: дальность D12, дистанция 4 = бросок 7+)
2. **Given** техника находится в секторе сниженной скорости (половина прочности), **When** выполняется расчёт попадания, **Then** сектор скорости НЕ влияет на дистанцию атаки (только на движение техники)
3. **Given** техника получила урон, равный её текущей прочности, **When** применяется урон, **Then** техника уничтожена (прочность = 0, стр. 16)
4. **Given** техника с оружием "2D12" попадает по пехоте, **When** выполняется расчёт урона, **Then** каждый кубик > брони цели наносит 1 ранение (по правилам "Виртуальной стрельбы" стр. 14)
5. **Given** техника с оружием "2D12" попадает по другой технике, **When** выполняется расчёт урона, **Then** используется механика атаки техники: каждый кубик сравнивается с бронёй отдельно, результаты НЕ суммируются

---

### User Story 4 - Рукопашный бой по официальным правилам (Priority: P2)

При рукопашном бою обе стороны бросают D6 и добавляют свой показатель ближнего боя (ББ). Победитель наносит урон равный разнице totals. При ничьей переигровка.

**Why this priority**: Рукопашный бой важен для полного соответствия официальным правилам. Текущая реализация корректна, но должна быть явно задокументирована.

**Independent Test**: Инициирование рукопашного боя, проверка результата по формуле D6+ББ атакующего vs D6+ББ защищающегося из официальных правил (стр. 15).

**Acceptance Scenarios**:

1. **Given** атакующий с ББ 3 атакует врукопашную защитника с ББ 2, **When** выполняется расчёт, **Then** оба бросают D6 и прибавляют свой ББ, победитель определяется по большей сумме
2. **Given** атакующий победил (сумма 8) против защитника (сумма 5), **When** рассчитывается урон, **Then** урон равен 3 (разница totals, по правилам стр. 15)
3. **Given** обе стороны выбрали равную сумму, **When** определяется победитель, **Then** объявляется ничья и требуется переигровка (по правилам стр. 15)
4. **Given** защита с техникой проиграла рукопашную, **When** применяется урон, **Then** техника теряет прочность равную разнице totals

---

### User Story 5 - Рукопашный бой по фанатским правилам (Priority: P2)

При рукопашном бою в фанатских правилах используется та же механика, что и в официальных: обе стороны бросают D6 и добавляют свой показатель ближнего боя (ББ). Победитель наносит урон равный разнице totals. При ничьей переигровка.

**Why this priority**: Рукопашный бой важен для полного соответствия фанатским правилам. Механика идентична официальным правилам, но должна быть явно задокументирована для фанатской редакции.

**Independent Test**: Инициирование рукопашного боя с выбранной фанатской редакцией правил, проверка результата по формуле D6+ББ атакующего vs D6+ББ защищающегося.

**Acceptance Scenarios**:

1. **Given** выбраны фанатские правила, атакующий с ББ 3 атакует врукопашную защитника с ББ 2, **When** выполняется расчёт, **Then** оба бросают D6 и прибавляют свой ББ, победитель определяется по большей сумме
2. **Given** атакующий победил (сумма 8) против защитника (сумма 5) в фанатских правилах, **When** рассчитывается урон, **Then** урон равен 3 (разница totals)
3. **Given** обе стороны выбрали равную сумму в фанатских правилах, **When** определяется победитель, **Then** объявляется ничья и требуется переигровка
4. **Given** защита с техникой проиграла рукопашную в фанатских правилах, **When** применяется урон, **Then** техника теряет прочность равную разнице totals

---

### User Story 6 - Расчёт урона по технике в фанатских правилах (Priority: P2)

При атаке техники в фанатских правилах используется единая механика для всех типов атак (пехота по технике, техника по технике). Урон рассчитывается сравнением значения кубика мощности с зоной шкалы прочности. Шкала прочности имеет три зоны: зелёная (высокая прочность), жёлтая (средняя), красная (низкая).

**Механика расчёта урона по технике (стр. 27)**:
1. Определяется зона прочности по положению маркера на шкале
2. Каждый кубик мощности сравнивается с максимальным значением текущей зоны
3. Если кубик > максимального значения зоны, броня пробита
4. При пробитии: D6 = 1 урон, D12 = 2 урона, D20 = 3 урона

**Why this priority**: Фанатские правила используют особую механику для урона по технике, отличную от официальных правил. Текущая реализация в `rules/fan.ts` не соответствует этой механике.

**Independent Test**: Атака по технике с разными типами атак и целей, проверка результата по правилам из PDF (стр. 27).

**Acceptance Scenarios**:

1. **Given** техника с мощью "2D12" стреляет по другой технике в зелёной зоне прочности (макс. значение 9) в фанатских правилах, **When** выпадают кубики 5 и 11, **Then** кубик 5 не пробивает (5<=9), кубик 11 пробивает (11>9) и наносит 2 урона
2. **Given** техника с мощью "D6" атакует технику в красной зоне прочности (макс. значение 3) в фанатских правилах, **When** выпадает кубик 4, **Then** броня пробита (4>3) и наносится 1 урон
3. **Given** техника с мощью "D20" атакует технику в зелёной зоне прочности (макс. значение 9) в фанатских правилах, **When** выпадает кубик 7, **Then** броня пробита (7>9=false, НЕ пробита) - кубик D20 может не пробить зелёную зону
4. **Given** пехота атакует технику с мощью "D12" в жёлтой зоне прочности (макс. значение 6) в фанатских правилах, **When** выпадает кубик 8, **Then** броня пробита (8>6) и наносится 2 урона
5. **Given** техника с мощью "3D6" стреляет по технике в красной зоне (макс. значение 3) в фанатских правилах, **When** выпадают кубики 2, 4, 5, **Then** только кубики 4 и 5 пробивают броню, итого 2 урона (по 1 за каждый пробитый кубик)

---

### User Story 7 - Расчёт урона пехоты по фанатским правилам (Priority: P2)

При атаке пехоты в фанатских правилах используется механика из правил Панова: каждый кубик мощности сравнивается с бронёй, бонус добавляется к каждому кубику. Укрепления (укрытия) цели влияют на эффективную дальность атаки.

**Why this priority**: Фанатские правила популярны среди игроков, и механика урона пехоты отличается от официальных правил применением бонусов и учётом укреплений.

**Independent Test**: Атака пехоты с разной мощью, бронёй и учётом укреплений цели, проверка результата по правилам из PDF (rules-originnal.pdf).

**Acceptance Scenarios**:

1. **Given** попадание с мощью "1D6" по цели с бронёй 1 без укреплений, **When** выполняется расчёт урона по фанатским правилам, **Then** кубик бросается, если результат >1 наносится 1 ранение
2. **Given** попадание с мощью "2D6+2" по цели с бронёй 2, **When** выполняется расчёт урона по фанатским правилам, **Then** каждый кубик бросается с +2 бонусом (каждый результат = roll+2), затем каждый результат+2 > 2 наносит 1 ранение
3. **Given** цель в лёгком укрытии (укрепления), **When** выполняется расчёт попадания, **Then** эффективная дальность атакующего уменьшается на 1 шаг (укрытие усложняет попадание)
4. **Given** цель в полном укрытии (бункер), **When** выполняется расчёт попадания, **Then** эффективная дальность атакующего уменьшается на 2 шага (сильное укрепление)
5. **Given** атакующий на дистанции 4 стреляет по цели в полном укрытии, **When** выполняется расчёт попадания с дальностью D12, **Then** используется таблица для дистанции 6 (4+2), требуемый бросок выше

---

### User Story 8 - Информационный текст о правилах расчёта (Priority: P1)

Пользователь может нажать на иконку информации в модале атаки, чтобы увидеть краткое описание механики расчёта для текущей редакции правил с примерами.

**Why this priority**: Пользователи должны понимать, как работают расчёты, чтобы доверять результатам и уметь проверять их по таблицам. Информация не должна загромождать основной интерфейс.

**Independent Test**: Открытие модаля атаки, нажатие на иконку информации, проверка наличия текстового блока с объяснением правил, соответствующего выбранной редакции.

**Minimum Content Requirements**:
- Заголовок с названием редакции правил ("Официальные правила (Технолог)" или "Фанатские правила (Панов)")
- Краткое описание механики попадания (1-2 предложения)
- Краткое описание механики урона для пехоты (1-2 предложения)
- Краткое описание механики урона для техники (1-2 предложения, если отличается от пехоты)
- Таблица модификаторов укреплений (fortification) с названиями и значениями
- Ссылки на TXT файлы с полными правилами (docs/original/official_rules.txt или docs/panov/fan_rules.txt)
- Минимум 150 символов текста для официальных правил, минимум 200 символов для фанатских правил (из-за более сложной механики техники)
- Максимум 800 символов текста для каждой редакции (чтобы не перегружать интерфейс)

**Acceptance Scenarios**:

1. **Given** пользователь выбрал официальные правила, **When** он нажимает на иконку информации в модале атаки, **Then** появляется всплывающее окно с заголовком "Официальные правила (Технолог)" и кратким описанием: прямое сравнение для попадания (Раздел 7), виртуальная стрельба для урона, таблица укреплений
2. **Given** пользователь выбрал фанатские правила, **When** он нажимает на иконку информации, **Then** появляется всплывающее окно с заголовком "Фанатские правила (Панов)" и кратким описанием механики (упрощённая формула попадания, зона-based урон для техники, таблица укреплений)
3. **Given** выполняется расчёт попадания, **When** показан результат, **Then** рядом с результатом отображается краткая подсказка с требуемым броском
4. **Given** выполняется расчёт урона, **When** показан результат, **Then** рядом с результатом отображается краткая подсказка с расчётом ранений
5. **Given** пользователь закрывает всплывающее окно с информацией, **When** он продолжает работу, **Then** информационный текст больше не виден, но иконка информации остаётся доступной
6. **Given** информационный модал открыт, **When** пользователь прокручивает контент, **Then** текст полностью читаем на мобильном устройстве, ссылки кликабельны

---

### Edge Cases

- Что происходит при атаке гранатомёта (D20+2) по пехоте в официальных правилах - бонус в дальности применяется к попаданию, но НЕ к урону?
- Как обрабатывается броня 0 (некоторые юниты без брони) в официальных правилах - каждый кубик >0 наносит 1 ранение?
- Что происходит при равном результате в рукопашной (ничья) - переигровка по официальным правилам?
- Как обрабатывается ситуация когда все кубики <= брони в официальных правилах - урон 0?
- Что происходит при дистанции больше 10 для D20 - промах автоматически по официальным правилам?
- В фанатских правилах: что происходит при сумме модификаторов > +19 или < -19 для броска по технике?
- В фанатских правилах: какие модификаторы применяются к броску D20 по технике (тип оружия, дистанция, укрытие, размер цели)?
- Как обрабатываются отрицательные бонусы в формате `D6-1` или `2D6-2` для попадания?
- В фанатских правилах: как лёгкое укрытие влияет на дистанцию атаки - эффективная дальность уменьшается на 1?
- В фанатских правилах: как полное укрытие (бункер) влияет на дистанцию атаки - эффективная дальность уменьшается на 2?
- В официальных правилах: как лёгкое укрепление влияет на расчёт урона - эффективная броня увеличивается на +1?
- В официальных правилах: как бункер влияет на расчёт урона - эффективная броня увеличивается на +2?
- В официальных правилах: как тяжёлое укрепление (бункер+) влияет на расчёт урона - эффективная броня увеличивается на +3?
- **UI: Что происходит если пользователь не выбрал тип укрытия цели - по умолчанию используется "Без укрытия"**
- **UI: Как визуально отображается выбранный тип укрытия в модале атаки - активная подсветка выбранной кнопки**

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА реализовать механику прямого сравнения для попадания из официальных правил (Раздел 7): бросок кубика дальности >= расстоянию до цели = попадание. Бонус в дальности прибавляется к результату броска.
- **FR-002**: Система ДОЛЖНА реализовать механику "Виртуальной стрельбы" для урона пехоты из официальных правил (стр. 14 Bronepekhota_Pravila_05_08_08.pdf): каждый кубик мощности, превышающий броню цели, наносит 1 ранение
- **FR-002a**: Для официальных правил бонус в мощности (например, `2D6+2`) ДОЛЖЕН прибавляться к каждому кубику перед сравнением с бронёй (механика идентична фанатским правилам)
- **FR-002b**: Система ДОЛЖНА учитывать укрепления (укрытия) цели при расчёте урона в официальных правилах: три типа укреплений - лёгкое укрепление = +1 к броне, бункер = +2 к броне, тяжёлое укрепление (бункер+) = +3 к брони
- **FR-002c**: Система ДОЛЖНА учитывать укрепления (укрытия) цели при расчёте попадания в фанатских правилах: укрепления увеличивают эффективную дистанцию (лёгкое укрытие = +1 к дистанции, полное укрытие/бункер = +2 к дистанции)
- **FR-002d**: Система ДОЛЖНА предоставлять UI для выбора укреплений цели в модале атаки: четыре визуальные кнопки "Без укрытия", "Лёгкое укрытие", "Полное укрытие (бункер)", "Тяжёлое укрепление (бункер+)". Выбор по умолчанию - "Без укрытия". В официальных правилах модификаторы: лёгкое = +1 к броне, полное = +2 к броне, тяжёлое = +3 к броне. В фанатских правилах модификаторы: лёгкое = +1 к дистанции, полное = +2 к дистанции.
- **FR-003**: Система ДОЛЖНА реализовать механику атаки техники из официальных правил (стр. 15-16 Bronepekhota_Pravila_05_08_08.pdf) для редакции 'tehnolog': урон вычитается из прочности, секторы скорости влияют на дистанцию
- **FR-003c**: Для официальных правил урон техники по технике использует механику "Виртуальной стрельбы" - каждый кубик мощности, превышающий броню, наносит 1 урон (кубики НЕ суммируются)
- **FR-003a**: Система ДОЛЖНА реализовать механику урона по технике в фанатских правилах (стр. 27 rules-originnal.pdf): единая механика для всех типов атак (пехота по технике, техника по технике). Урон рассчитывается сравнением значения кубика мощности с зоной шкалы прочности. При пробитии: D6 = 1 урон, D12 = 2 урона, D20 = 3 урона.
- **FR-003f**: Система ДОЛЖНА поддерживать три зоны прочности техники в фанатских правилах: зелёная (высокая прочность), жёлтая (средняя), красная (низкая). Максимальное значение каждой зоны используется для определения пробития брони. Зоны хранятся в армлисте техники как массив диапазонов: `durabilityZones: [{max: number, color: string}]`.
- **FR-003d**: Система ДОЛЖНА реализовать механику урона по пехоте для фанатских правил: каждый кубик мощности с бонусом сравнивается с бронёй, каждый кубик > брони наносит 1 ранение
- **FR-003e**: Система ДОЛЖНА учитывать влияние укреплений (укрытий) цели на дистанцию атаки в фанатских правилах: лёгкое укрытие = +1 к эффективной дистанции, полное укрытие (бункер) = +2 к эффективной дистанции
- **FR-003b**: (Удалено - уровни повреждения техники не используются в фанатских правилах, урон вычитается напрямую из прочности)
- **FR-004**: (Удалено - lookup-таблица не используется в официальных правилах)
- **FR-004a**: Система ДОЛЖНА поддерживать расчёт рукопашного боя для фанатских правил: механика идентична официальным (D6+ББ атакующего vs D6+ББ защитника, урон = разница totals)
- **FR-005**: Секторы скорости техники НЕ ДОЛЖНЫ влиять на расчёт попадания - они влияют только на максимальную дистанцию перемещения техники
- **FR-006**: Система ДОЛЖНА предоставлять иконку информации в модале атаки, при нажатии на которую показывается всплывающее окно с кратким описанием механики расчёта для текущей редакции правил
- **FR-007**: Система ДОЛЖНА включать в информационный текст ссылки на TXT файлы с соответствующими правилами (docs/original/official_rules.txt для официальных правил, docs/panov/fan_rules.txt для фанатских)
- **FR-008**: Функция calculateHit ДОЛЖНА использовать механику прямого сравнения для официальных правил: бросок кубика дальности (с бонусом если есть) >= расстоянию = попадание
- **FR-009**: Функция calculateDamage ДОЛЖНА использовать механику "каждый кубик > брони = 1 ранение" для официальных правил
- **FR-010**: Система ДОЛЖНА корректно обрабатывать формат параметров с бонусом (например, `2D6+2`, `D12+1`) для попадания
- **FR-010a**: Для официальных правил бонус в мощности ДОЛЖЕН прибавляться к каждому кубику перед сравнением с бронёй
- **FR-010b**: Для фанатских правил бонус в мощности должен добавляться к каждому броску кубика перед сравнением с броней (текущая реализация в `game-logic.ts` line 46 верна для фанатских правил, механика идентична официальным)
- **FR-010c**: Для попадания бонус должен прибавляться к результату броска кубика(ов) перед сравнением с требуемым значением в обеих редакциях правил

### Key Entities

- **AimRange (Прицельная дальность - официальные правила)**: Значение броска по кубику дальности оружия (D6, D12, D20), которое определяет максимальную дальность точного выстрела. Вычисляется в начале каждого выстрела по графе "Дальность стрельбы". Если прицельная дальность >= расстояние до цели (в шагах), то выстрел точный. Используется только в официальных правилах (Раздел 7).
- **HitTable (Таблица попадания - фанатские правила)**: Lookup-таблица из фанатских правил, сопоставляющая дистанцию (1-10) и тип оружия (D6, D12, D20) с требуемым броском. НЕ ИСПОЛЬЗУЕТСЯ в официальных правилах.
- **DamageTable (Таблица урона по пехоте)**: НЕ ИСПОЛЬЗУЕТСЯ в официальных правилах. Урон рассчитывается по правилу "Виртуальная стрельба" (стр. 14): каждый кубик мощности, превышающий броню цели, наносит 1 ранение в реальном времени
- **DurabilityZone (Зона прочности - фанатские правила)**: Одна из трёх зон шкалы прочности техники: зелёная (высокая прочность), жёлтая (средняя), красная (низкая). Каждая зона имеет максимальное значение, которое сравнивается с кубиком мощности при расчёте урона по технике в фанатских правилах. Зоны хранятся в армлисте как массив диапазонов: `[{max: 9, color: 'green'}, {max: 6, color: 'yellow'}, {max: 3, color: 'red'}]`.
- **SpeedSector (Сектор скорости)**: Диапазон прочности техники с модификатором скорости (полная/половина). Влияет только на максимальную дистанцию перемещения техники, НЕ влияет на расчёт попадания. В фанатских правилах скорость вычисляется согласно текущей прочности: каждая зона прочности (зелёная/жёлтая/красная) имеет соответствующее значение скорости, которое используется для определения максимальной дистанции перемещения.
- **RulesDescription (Описание правил)**: Краткое текстовое описание правил расчёта (таблица попадания/виртуальная стрельба), которое показывается во всплывающем окне при нажатии на иконку информации. Включает ссылки на соответствующие страницы PDF.
- **RollBonus (Бонус броска)**: Числовое значение в формате `XdY+Z` (например, `2D6+2`), где `X` - количество кубиков, `Y` - граней кубика, `Z` - бонус к результату. Бонус прибавляется к сумме всех бросков для попадания; для урона бонус прибавляется к каждому кубику перед сравнением с бронёй (в обеих редакциях правил)
- **Fortification (Укрепление/Укрытие)**: Тип защиты цели. В официальных правилах: увеличивает броню цели (лёгкое укрепление = +1 к броне, бункер = +2 к брони, тяжёлое укрепление/бункер+ = +3 к брони). В фанатских правилах: увеличивает эффективную дистанцию атаки (лёгкое укрытие = +1 к дистанции, полное укрытие/бункер = +2 к дистанции). Выбирается пользователем в модале атаки через визуальный интерфейс с четырьмя кнопками: "Без укрытия", "Лёгкое укрытие", "Полное укрытие (бункер)", "Тяжёлое укрепление (бункер+)".

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Расчёт попадания пехоты использует механику прямого сравнения из официальных правил (Раздел 7): бросок кубика дальности >= расстоянию = попадание
- **SC-001a**: Расчёт попадания пехоты в фанатских правилах использует lookup-таблицу (таблица дистанции vs дальность)
- **SC-002**: Расчёт урона пехоты использует механику "Виртуальной стрельбы" (стр. 14): каждый кубик > брони = 1 ранение, средние значения совпадают с теоретическими
- **SC-002a**: Расчёт урона пехоты в официальных правилах учитывает укрепления цели: лёгкое укрепление = +1 к броне, бункер = +2 к брони, тяжёлое укрепление (бункер+) = +3 к брони
- **SC-002b**: Расчёт попадания пехоты в фанатских правилах учитывает укрепления цели: лёгкое укрытие = +1 к дистанции, бункер = +2 к дистанции
- **SC-003**: Секторы скорости техники НЕ влияют на расчёт попадания - влияют только на дистанцию перемещения техники
- **SC-003a**: Расчёт урона по технике в фанатских правилах использует механику сравнения с зоной прочности (стр. 27 rules-originnal.pdf): кубик мощности сравнивается с максимальным значением зоны, при пробитии D6=1, D12=2, D20=3 урона
- **SC-003b**: Расчёт урона по пехоте в фанатских правилах учитывает бонусы к мощности (каждый кубик+бонус > брони = 1 ранение)
- **SC-003c**: Расчёт попадания в фанатских правилах учитывает укрепления цели: лёгкое укрытие = +1 дистанция, полное укрытие = +2 дистанции
- **SC-004**: Иконка информации доступна в модале атаки, при нажатии показывается всплывающее окно с кратким описанием механики расчёта и ссылками на PDF
- **SC-005**: Все тестовые примеры из официальных правил (стр. 13-16) дают идентичные результаты

## Assumptions and Dependencies

### Assumptions

- Система выбора редакции правил уже реализована (предыдущая спецификация 002-rules-version-selection)
- Пользователь может переключаться между редакциями правил без потери состояния игры
- TXT-файлы с правилами (конвертированные из PDF) являются авторитетным источником истины
- Lookup-таблицы будут хардкодиться в код на основе данных из TXT файлов

### Dependencies

- TXT-файл `docs/original/official_rules.txt` (официальные правила - конвертирован из Bronepekhota_Pravila_05_08_08.pdf)
- TXT-файл `docs/panov/fan_rules.txt` (фанатские правила - конвертирован из rules-originnal.pdf)
- Существующая система выбора редакции правил (RulesVersionID, rulesRegistry)
- TypeScript и React для UI компонентов

## Notes

**Ключевые различия между редакциями правил:**

### Официальные правила (Технолог) - БРОНЕПЕХОТА:
- **Попадание пехоты**: Механика прямого сравнения из Раздела 7 (см. official_rules.txt) - бросок кубика дальности (D6, D12, D20) сравнивается с расстоянием до цели. Если результат броска >= расстоянию, попадание точное. Бонус в дальности прибавляется к результату броска.
  - Пример: Дальность D6 на дистанции 2 - бросок D6, если выпало 2+ = попадание
  - Пример: Дальность D6+2 на дистанции 4 - бросок D6, если выпало 2+ = попадание (2+2=4)
- **Урон пехоты**: Механика "Виртуальной стрельбы" (см. official_rules.txt, раздел про повреждения) - каждый кубик мощности, превышающий броню цели, наносит 1 ранение. Бонусы в мощности (например, `2D6+2`) прибавляются к каждому кубику перед сравнением с бронёй (механика идентична фанатским правилам). Укрепления (fortification) цели увеличивают броню (лёгкое = +1, бункер = +2, тяжёлое укрепление/бункер+ = +3).
- **Техника**: Урон вычитается из прочности (см. official_rules.txt, раздел про боевую технику). Секторы скорости влияют только на движение техники, НЕ на расчёт попадания. Урон техники по технике использует механику "Виртуальной стрельбы" - каждый кубик мощности, превышающий броню, наносит 1 урон.
- **Рукопашная**: D6+ББ атакующего vs D6+ББ защитника, урон = разница (см. official_rules.txt)

### Фанатские правила (Панов) - частично реализованы в `rules/fan.ts` (требуется исправление урона по технике):
- **Попадание**: Формула `total >= distanceSteps` (упрощённая) ИЛИ lookup-таблица для более точных расчётов
- **Рукопашная**: D6+ББ атакующего vs D6+ББ защитника, урон = разница totals (механика идентична официальным правилам)
- **Укрепления влияют на дистанцию**: лёгкое укрытие = +1 к эффективной дистанции, полное укрытие/бункер = +2 к эффективной дистанции
- **Урон по пехоте**: Каждый кубик мощности бросается с бонусом (если есть), затем каждый результат > брони наносит 1 ранение
- **Урон по технике**: Единая механика для всех типов атак (пехота по технике, техника по технике). Сравнение значения кубика мощности с максимальным значением зоны прочности (зелёная/жёлтая/красная). При пробитии: D6 = 1 урон, D12 = 2 урона, D20 = 3 урона.
- **Специальные эффекты**: Поддержка эффектов (Взрыв, Ремонт, Burst)

**Текущие проблемы**:
1. Функция `calculateHit` в `rules/tehnolog.ts` использует упрощённую формулу `total >= distanceSteps`, что СООТВЕТСТВУЕТ официальным правилам (см. official_rules.txt, Раздел 7) - механика прямого сравнения верна.
2. Функция `calculateDamage` в `rules/tehnolog.ts` использует формулу `roll > armor`, что совпадает с механикой "Виртуальной стрельбы" (см. official_rules.txt). Эта механика ПРАВИЛЬНА для всех типов атак в официальных правилах (пехота по пехоте, техника по пехоте, техника по технике).
3. В `rules/fan.ts` механика урона по технике НЕ соответствует фанатским правилам. Текущая реализация использует `roll > armor` (Виртуальная стрельба), но для фанатских правил должна использоваться механика сравнения с зоной прочности с фиксированным уроном по типу кубика (D6=1, D12=2, D20=3).
4. В `game-logic.ts` line 46 бонус добавляется к каждому кубику отдельно `(rollDie(sides) + bonus)`, что правильно для обеих редакций правил (механика идентична для официальных и фанатских правил).

## Clarifications

### Session 2025-01-14

- Q: Какая механика урона используется для атаки по технике в официальных правилах? → A: Виртуальная стрельба (roll > armor) для всех типов атак
- Q: Какая механика урона используется для атаки по технике в фанатских правилах? → A: Сравнение кубика с зоной прочности (зелёная/жёлтая/красная), D6=1, D12=2, D20=3 урон при пробитии

### Session 2025-01-14 (Clarification)

- Q: Как зоны прочности техники (зелёная/жёлтая/красная) будут определены в данных для фанатских правил? → A: Зоны хранятся в армлисте как массив диапазонов [{max: 9, color: 'green'}, {max: 6, color: 'yellow'}, {max: 3, color: 'red'}]
- Q: Как пользователь должен указывать укрепления (укрытия) цели при расчёте атаки? → A: Визуальный выбор на мини-карте с тремя кнопками: "Без укрытия", "Лёгкое укрытие", "Полное укрытие"
- Q: Какой модификатор у тяжёлого укрепления (бункер+) в официальных правилах? → A: Тяжёлое укрепление (бункер+) увеличивает броню цели на +3 в официальных правилах. Это усиленный вариант бункера (+2).

### Session 2025-01-15

- Q: Как текущий сектор скорости техники (полная/половина прочности) сопоставляется с зоной прочности (зелёная/жёлтая/красная) в фанатских правилах? → A: Скорость вычисляется согласно текущей прочности, у каждой зоны есть соответствующая ей скорость.
